import{r as o,u as R,a as T,b as V,j as e}from"./index-BBFhNgLA.js";import{g as C,p as B,a as H,b as S}from"./api-BUuAVsLY.js";import{L as W}from"./ErrorBoundary-C7XI_3jQ.js";import{M as G}from"./Modal-BllzMBoT.js";const P=l=>{if(!l)return"-";try{return new Date(l).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return"-"}},F=l=>l?parseFloat(l).toFixed(2):"0.00",J=(l,f)=>{const d=new Date,w=new Date(f);return l==="paid"?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",children:"Paid"}):l==="overdue"?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",children:"Overdue"}):w<d?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",children:"Overdue"}):e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300",children:"Pending"})};function Z(){const[l,f]=o.useState([]),[d,w]=o.useState(null),[g,D]=o.useState([]),[M,N]=o.useState(!1),[O,h]=o.useState(!1),[m,A]=o.useState(""),[c,p]=o.useState({installments:[{due_date:"",amount:""}]}),[v,y]=o.useState(!1),{token:i,logout:k}=R(),r=T(),b=V(),x=t=>{t.message.includes("Session expired")||t.message.includes("Unauthorized")||t.status===401?(r.show("Session expired. Please log in again.","error"),k(),b("/login-supplier")):r.show(t.message||"An error occurred","error")},_=async()=>{try{N(!0);const t=await C("/api/supplier/orders",{token:i}),n=(t.data?.orders||t.data||t||[]).map(a=>({...a,has_installments:a.has_installments||!1}));f(n)}catch(t){x(t)}finally{N(!1)}},u=async t=>{try{const s=await C(`/api/supplier/installments/order/${t}`,{token:i});D(s.data?.installments||s.data||[])}catch(s){x(s)}},U=async()=>{if(d){if(!i){r.show("No authentication token found. Please log in again.","error"),k(),b("/login-supplier");return}try{y(!0);const t=c.installments.filter(a=>a.due_date&&a.amount&&parseFloat(a.amount)>0);if(t.length===0){r.show("Please add at least one valid installment","error");return}const s={installments:t.map(a=>({due_date:a.due_date,amount:parseFloat(a.amount)}))};console.log("Sending request with token:",i?"Token exists":"No token"),console.log("Request data:",s);const n=await B(`/api/supplier/installments/order/${d.id}/create`,{data:s,token:i});n.success?(r.show("Installment plan created successfully","success"),h(!1),_(),u(d.id)):r.show(n.message||"Failed to create installment plan","error")}catch(t){console.error("Create installment error:",t),t.status===401||t.message?.includes("Unauthorized")?x(t):r.show(t.message||"Failed to create installment plan","error")}finally{y(!1)}}},$=async()=>{if(d)try{y(!0);const t=c.installments.filter(a=>a.due_date&&a.amount&&parseFloat(a.amount)>0);if(t.length===0){r.show("Please add at least one valid installment","error");return}const s={installments:t.map(a=>({due_date:a.due_date,amount:parseFloat(a.amount)}))},n=await H(`/api/supplier/installments/order/${d.id}/update`,{data:s,token:i});n.success?(r.show("Installment plan updated successfully","success"),h(!1),u(d.id)):r.show(n.message||"Failed to update installment plan","error")}catch(t){console.error("Update installment error:",t),t.status===401||t.message?.includes("Unauthorized")?x(t):r.show(t.message||"Failed to update installment plan","error")}finally{y(!1)}},q=async t=>{try{const s=await S(`/api/supplier/installments/installments/${t}/mark-paid`,{data:{},token:i});s.success?(r.show("Installment marked as paid","success"),u(d.id)):r.show(s.message||"Failed to mark as paid","error")}catch(s){console.error("Mark as paid error:",s),s.status===401||s.message?.includes("Unauthorized")?x(s):r.show(s.message||"Failed to mark as paid","error")}},E=async t=>{try{const s=await S(`/api/supplier/installments/installments/${t}/mark-overdue`,{data:{},token:i});s.success?(r.show("Installment marked as overdue","success"),u(d.id)):r.show(s.message||"Failed to mark as overdue","error")}catch(s){console.error("Mark as overdue error:",s),s.status===401||s.message?.includes("Unauthorized")?x(s):r.show(s.message||"Failed to mark as overdue","error")}},I=o.useCallback((t,s,n)=>{const a=[...c.installments];a[t]={...a[t],[s]:n},p({installments:a})},[c.installments]),L=()=>{p({installments:[...c.installments,{due_date:"",amount:""}]})},z=t=>{if(c.installments.length>1){const s=c.installments.filter((n,a)=>a!==t);p({installments:s})}},j=(t,s=null)=>{A(t),w(s),t==="view"&&s?u(s.id):t==="edit"&&s?u(s.id).then(()=>{g.length>0&&p({installments:g.map(n=>({due_date:n.due_date,amount:n.amount}))})}):t==="create"&&s&&p({installments:[{due_date:"",amount:""}]}),h(!0)};return o.useEffect(()=>{i?_():(r.show("Please log in to access this page","error"),b("/login-supplier"))},[i,b]),M?e.jsx("div",{className:"min-h-screen bg-theme-bg p-6",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsx(W,{type:"dashboard"})})}):e.jsx("div",{className:"min-h-screen bg-theme-bg p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-theme-text mb-2",children:"Installment Management"}),e.jsx("p",{className:"text-theme-text-secondary",children:"Manage installment plans for your client orders"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-sm border border-theme-border",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-theme-border",children:[e.jsx("h2",{className:"text-lg font-semibold text-theme-text",children:"Orders with Installments"}),e.jsx("p",{className:"text-sm text-theme-text-secondary mt-1",children:"View and manage installment plans for client orders"})]}),l.length===0?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"text-theme-text-muted mb-4",children:e.jsx("svg",{className:"mx-auto h-12 w-12",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})})}),e.jsx("h3",{className:"text-lg font-medium text-theme-text mb-2",children:"No orders available"}),e.jsx("p",{className:"text-theme-text-secondary",children:"No orders are available for installment management at the moment."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-theme-border",children:[e.jsx("thead",{className:"bg-theme-surface",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Order"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Client"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Total Amount"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Order Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Installment Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-900 divide-y divide-theme-border",children:l.map(t=>e.jsxs("tr",{className:"hover:bg-theme-surface transition-colors duration-200",children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm font-medium text-theme-text",children:["#",t.order_number||t.id]}),e.jsx("div",{className:"text-sm text-theme-text-secondary",children:t.status||"Pending"})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-theme-text",children:t.client?.name||t.client_name||"Unknown Client"}),e.jsx("div",{className:"text-sm text-theme-text-secondary",children:t.client?.email||t.client_email||"No email"})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-theme-text",children:["$",F(t.total_amount||t.amount)]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-theme-text-secondary",children:P(t.created_at)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.has_installments?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",children:"Has Installments"}):e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300",children:"No Installments"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>j("view",t),className:"text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300",children:"View"}),!t.has_installments&&e.jsx("button",{onClick:()=>{j("create",t)},className:"text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300",children:"Create Plan"}),t.has_installments&&e.jsx("button",{onClick:()=>j("edit",t),className:"text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300",children:"Edit Plan"})]})})]},t.id))})]})})]}),e.jsx(G,{open:O,onClose:()=>h(!1),title:m==="create"?"Create Installment Plan":m==="edit"?"Edit Installment Plan":"View Installment Plan",children:m==="view"?e.jsx("div",{children:g.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-theme-text-secondary",children:"No installments found for this order."})}):e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-theme-border",children:[e.jsx("thead",{className:"bg-theme-surface",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Due Date"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-theme-text-secondary uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-900 divide-y divide-theme-border",children:g.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-theme-text",children:P(t.due_date)}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-theme-text",children:["$",F(t.amount)]}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:J(t.status,t.due_date)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex space-x-2",children:[t.status!=="paid"&&e.jsx("button",{onClick:()=>q(t.id),className:"text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300",children:"Mark Paid"}),t.status!=="overdue"&&e.jsx("button",{onClick:()=>E(t.id),className:"text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300",children:"Mark Overdue"})]})})]},t.id))})]})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-4",children:c.installments.map((t,s)=>e.jsxs("div",{className:"flex space-x-4 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-theme-text mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:t.due_date,onChange:n=>I(s,"due_date",n.target.value),className:"w-full px-3 py-2 border border-theme-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-800 dark:text-white",required:!0})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-theme-text mb-1",children:"Amount"}),e.jsx("input",{type:"number",step:"0.01",value:t.amount,onChange:n=>I(s,"amount",n.target.value),className:"w-full px-3 py-2 border border-theme-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-800 dark:text-white",placeholder:"0.00",required:!0})]}),c.installments.length>1&&e.jsx("button",{type:"button",onClick:()=>z(s),className:"px-3 py-2 text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300",children:"Remove"})]},s))}),e.jsx("button",{type:"button",onClick:L,className:"w-full px-4 py-2 border-2 border-dashed border-theme-border rounded-md text-theme-text-secondary hover:text-theme-text hover:border-theme-border-dark transition-colors duration-200",children:"+ Add Installment"}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{h(!1)},className:"px-4 py-2 text-theme-text-secondary hover:text-theme-text transition-colors duration-200",children:"Cancel"}),e.jsx("button",{type:"button",onClick:()=>{m==="create"?U():m==="edit"&&$()},disabled:v,className:"px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Saving...":m==="create"?"Create Plan":"Update Plan"})]})]})})]})})}export{Z as default};
