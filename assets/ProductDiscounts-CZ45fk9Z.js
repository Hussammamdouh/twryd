import{r as a,u as k,a as L,j as e}from"./index-Cclg67os.js";import{S as I}from"./StatusBadge-DJ6xvyJv.js";import{a as T,d as q,g as E}from"./api-BUuAVsLY.js";import{C as V}from"./ConfirmActionModal-BfRozEVT.js";import{S as A}from"./Spinner-BtaP2GZ9.js";import{M as R}from"./Modal-DoRxSVjK.js";import{P as O}from"./Pagination-0mAyFH-O.js";import{u as U}from"./Topbar-UkpslM12.js";import"./ThemeToggle-wdlk3O_i.js";function B({open:b,discount:o,onClose:g,onSuccess:j}){const[d,i]=a.useState(""),[m,p]=a.useState(!1),[h,l]=a.useState(""),{token:f}=k(),x=L();a.useEffect(()=>{o&&i(o.discount?.toString()||"")},[o]);const S=async c=>{if(c.preventDefault(),!d||d<0||d>100){l("Please enter a valid discount percentage (0-100)");return}p(!0),l("");try{await T(`/api/supplier-management/products/${o.product.id}/clients/${o.client.id}/default-discount`,{data:{default_discount:parseInt(d)},token:f}),x.show("Product discount updated successfully","success"),g(),j?.()}catch(C){l(C.message||"Failed to update product discount"),x.show(C.message||"Failed to update product discount","error")}finally{p(!1)}},y=()=>{i(""),l(""),g()};return o?e.jsx(R,{open:b,onClose:y,title:"Edit Product Discount",children:e.jsxs("form",{className:"flex flex-col gap-4",onSubmit:S,noValidate:!0,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-theme-text mb-1 font-medium",children:"Product"}),e.jsxs("div",{className:"px-4 py-2 bg-theme-surface border border-theme-border rounded text-theme-text",children:[o.product?.name||"N/A"," - ",o.product?.category?.name||"No category"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-theme-text mb-1 font-medium",children:"Client"}),e.jsxs("div",{className:"px-4 py-2 bg-theme-surface border border-theme-border rounded text-theme-text",children:[o.client?.name||o.client?.company_name||"N/A"," (",o.client?.email||"No email",")"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-theme-text mb-1 font-medium",children:"Discount Percentage"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",className:`theme-input w-full px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary-400 ${h?"border-red-400":""}`,placeholder:"Enter discount percentage (0-100)",value:d,onChange:c=>i(c.target.value),disabled:m,required:!0}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("span",{className:"text-theme-text-secondary text-sm",children:"%"})})]})]}),h&&e.jsx("div",{className:"text-red-500 text-sm",role:"alert",children:h}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx("button",{type:"button",className:"theme-button-secondary px-4 py-2 rounded font-semibold focus:outline-none",onClick:y,disabled:m,children:"Cancel"}),e.jsxs("button",{type:"submit",className:"theme-button px-4 py-2 rounded font-semibold shadow flex items-center gap-2 focus:outline-none",disabled:m,children:[m&&e.jsx(A,{size:16,color:"border-white"}),"Update Discount"]})]})]})}):null}const F=b=>{if(!b)return"-";try{return new Date(b).toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return"-"}};function G({productDiscounts:b,loading:o,onAction:g,onAdd:j}){const{token:d}=k(),[i,m]=a.useState({}),[p,h]=a.useState({open:!1,type:"",discount:null}),[l,f]=a.useState({open:!1,discount:null}),x=L(),S=async(t,u)=>{m(s=>({...s,[u.id]:!0}));try{t==="delete"&&(await q(`/api/supplier-management/products/${u.product.id}/clients/${u.client.id}/default-discount`,{token:d}),x.show("Product discount removed successfully","success")),g?.()}catch(s){x.show(s.message||"Action failed","error")}finally{m(s=>({...s,[u.id]:!1})),h({open:!1,type:"",discount:null})}},y=(t,u)=>h({open:!0,type:t,discount:u}),c=()=>h({open:!1,type:"",discount:null}),C=t=>f({open:!0,discount:t}),v=()=>f({open:!1,discount:null});return o?e.jsx("div",{className:"flex justify-center py-12 text-gray-500",children:e.jsx(A,{size:24})}):!b||b.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-400 gap-4",children:[e.jsx("div",{children:"No product discounts found."}),e.jsx("button",{className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2",onClick:j,children:"+ Add Product Discount"})]}):e.jsxs("div",{className:"overflow-x-auto rounded-lg shadow bg-white dark:bg-gray-900",children:[e.jsxs("table",{className:"min-w-full text-sm md:table bg-white dark:bg-gray-900",role:"table","aria-label":"Product Discounts Table",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-gray-700",role:"row",children:[e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Product Name"}),e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Discount %"}),e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Applies To"}),e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Start Date"}),e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Expiry Date"}),e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Status"}),e.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",role:"columnheader",children:"Actions"})]})}),e.jsx("tbody",{role:"rowgroup",children:b.map(t=>e.jsxs("tr",{className:"border-b last:border-0",role:"row",tabIndex:0,"aria-label":`Product: ${t.product?.name||"N/A"}, Client: ${t.client?.name||t.client?.company_name||"N/A"}`,children:[e.jsx("td",{className:"px-4 md:px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.product?.name||"N/A"}),e.jsx("div",{className:"text-gray-500 text-xs",children:t.product?.category?.name||"No category"})]})}),e.jsx("td",{className:"px-4 md:px-6 py-4 whitespace-nowrap",children:t.discount?`${t.discount}%`:"No discount"}),e.jsx("td",{className:"px-4 md:px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.client?.name||t.client?.company_name||"N/A"}),e.jsx("div",{className:"text-gray-500 text-xs",children:t.client?.email||"No email"})]})}),e.jsx("td",{className:"px-4 md:px-6 py-4 whitespace-nowrap",children:F(t.start_date)}),e.jsx("td",{className:"px-4 md:px-6 py-4 whitespace-nowrap",children:F(t.expiry_date)}),e.jsx("td",{className:"px-4 md:px-6 py-4",children:e.jsx(I,{status:t.status||(t.discount&&t.discount>0?"active":"inactive"),"aria-label":t.status||(t.discount&&t.discount>0?"active":"inactive")})}),e.jsxs("td",{className:"px-4 md:px-6 py-4 flex flex-wrap gap-2",children:[e.jsx("button",{className:"px-3 py-1 bg-blue-100 text-blue-700 rounded shadow text-xs font-bold hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400",onClick:()=>C(t),disabled:i[t.id],tabIndex:0,"aria-label":`Edit product discount for ${t.product?.name||"N/A"} and ${t.client?.name||t.client?.company_name||"N/A"}`,children:"Edit"}),e.jsxs("button",{className:"px-3 py-1 bg-red-100 text-red-700 rounded shadow text-xs font-bold hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-400",onClick:()=>y("delete",t),disabled:i[t.id],tabIndex:0,"aria-label":`Remove product discount for ${t.product?.name||"N/A"} and ${t.client?.name||t.client?.company_name||"N/A"}`,children:[i[t.id]&&e.jsx(A,{size:16,color:"border-red-700"}),"Delete"]})]})]},t.id))})]}),e.jsx(V,{isOpen:p.open,onClose:c,onConfirm:()=>S(p.type,p.discount),title:"Remove Product Discount",message:"Are you sure you want to remove this product discount? This action cannot be undone.",confirmText:"Remove Discount",confirmColor:"red",loading:i[p.discount?.id]}),e.jsx(B,{open:l.open,discount:l.discount,onClose:v,onSuccess:()=>{v(),g?.()}})]})}function H({open:b,onClose:o,onSuccess:g,products:j,clients:d}){const[i,m]=a.useState(""),[p,h]=a.useState(""),[l,f]=a.useState(""),[x,S]=a.useState(!1),[y,c]=a.useState(""),{token:C}=k(),v=L(),t=async s=>{if(s.preventDefault(),!i){c("Please select a product");return}if(!p){c("Please select a client");return}if(!l||l<0||l>100){c("Please enter a valid discount percentage (0-100)");return}S(!0),c("");try{await T(`/api/supplier-management/products/${i}/clients/${p}/default-discount`,{data:{default_discount:parseInt(l)},token:C}),v.show("Product discount added successfully","success"),m(""),h(""),f(""),o(),g?.()}catch(N){c(N.message||"Failed to add product discount"),v.show(N.message||"Failed to add product discount","error")}finally{S(!1)}},u=()=>{m(""),h(""),f(""),c(""),o()};return e.jsx(R,{open:b,onClose:u,title:"Add Product Discount",children:e.jsxs("form",{className:"flex flex-col gap-4",onSubmit:t,noValidate:!0,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-theme-text mb-1 font-medium",children:"Select Product"}),e.jsxs("select",{className:`theme-input w-full px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary-400 ${y&&!i?"border-red-400":""}`,value:i,onChange:s=>m(s.target.value),disabled:x,required:!0,children:[e.jsx("option",{value:"",children:"Choose a product..."}),j?.length>0?j.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ",s.category?.name||"No category"]},s.id)):e.jsx("option",{value:"",disabled:!0,children:"No products available"})]}),j?.length===0&&e.jsx("p",{className:"text-sm text-orange-600 dark:text-orange-400 mt-1",children:"No products found. Please create products first."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-theme-text mb-1 font-medium",children:"Select Client"}),e.jsxs("select",{className:`theme-input w-full px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary-400 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 ${y&&!p?"border-red-400":""}`,value:p,onChange:s=>h(s.target.value),disabled:x,required:!0,children:[e.jsx("option",{value:"",children:"Choose a client..."}),d?.length>0?d.map(s=>{const N=s.client||s,_=N.name||N.company_name||"Unknown Client",D=N.email||N.client_email||N.contact||"No email";return e.jsxs("option",{value:s.id,children:[_," (",D,")"]},s.id)}):e.jsx("option",{value:"",disabled:!0,children:"No clients available"})]}),d?.length===0&&e.jsx("p",{className:"text-sm text-orange-600 dark:text-orange-400 mt-1",children:"No clients found. Please invite clients first."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-theme-text mb-1 font-medium",children:"Discount Percentage"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",className:`theme-input w-full px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-primary-400 ${y&&!l?"border-red-400":""}`,placeholder:"Enter discount percentage (0-100)",value:l,onChange:s=>f(s.target.value),disabled:x,required:!0}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("span",{className:"text-theme-text-secondary text-sm",children:"%"})})]})]}),y&&e.jsx("div",{className:"text-red-500 text-sm",role:"alert",children:y}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx("button",{type:"button",className:"theme-button-secondary px-4 py-2 rounded font-semibold focus:outline-none",onClick:u,disabled:x,children:"Cancel"}),e.jsxs("button",{type:"submit",className:"theme-button px-4 py-2 rounded font-semibold shadow flex items-center gap-2 focus:outline-none",disabled:x,children:[x&&e.jsx(A,{size:16,color:"border-white"}),"Add Discount"]})]})]})})}function se(){const[b,o]=a.useState(!1),[g,j]=a.useState([]),[d,i]=a.useState([]),[m,p]=a.useState([]),[h,l]=a.useState(!1),[f,x]=a.useState(1),[S,y]=a.useState(1),[c,C]=a.useState(""),[v,t]=a.useState(""),{token:u}=k(),{sidebarCollapsed:s}=U(),N=async()=>{try{const n=await E("/api/supplier-management/products",{token:u}),r=Array.isArray(n.data)?n.data:n.data?.products?.data||n.data?.products||[];j(r)}catch(n){console.error("Failed to load products:",n.message);try{const r=await E("/api/supplier/products",{token:u}),P=Array.isArray(r.data)?r.data:r.data?.products?.data||r.data?.products||[];j(P)}catch(r){console.error("Fallback also failed:",r),j([])}}},_=async()=>{try{const n=await E("/api/supplier/invitations/clients",{token:u}),r=Array.isArray(n.data)?n.data:n.data?.clients?.data||n.data?.clients||[];i(r)}catch(n){console.error("Failed to load clients:",n.message)}},D=async(n=f)=>{l(!0);try{const r=[];for(const w of g)for(const M of d)w.default_discount&&w.default_discount>0&&r.push({id:`${w.id}-${M.id}`,product:w,client:M,discount:w.default_discount,start_date:w.created_at,expiry_date:w.discount_expiry_date,status:"active"});const P=10,$=r.slice((n-1)*P,n*P);p($),y(Math.ceil(r.length/P))}catch(r){console.error("Failed to load product discounts:",r.message)}finally{l(!1)}};a.useEffect(()=>{u&&(N(),_())},[u]),a.useEffect(()=>{g.length>0&&d.length>0&&D(f)},[g,d,f]);const z=a.useMemo(()=>m.filter(n=>{const r=n.product?.name||"",P=n.client?.name||n.client?.company_name||"",$=!c||r.toLowerCase().includes(c.toLowerCase())||P.toLowerCase().includes(c.toLowerCase()),w=!v||n.status===v;return $&&w}),[m,c,v]);return e.jsxs("div",{className:"min-h-screen bg-theme-bg",children:[e.jsx("main",{className:`pt-20 pr-8 transition-all duration-300 ${s?"pl-20":"pl-64"}`,children:e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsx(G,{productDiscounts:z,loading:h,onAction:D,onAdd:()=>o(!0)}),e.jsx(O,{page:f,totalPages:S,onPageChange:x})]})}),e.jsx(H,{open:b,onClose:()=>o(!1),onSuccess:D,products:g,clients:d})]})}export{se as default};
