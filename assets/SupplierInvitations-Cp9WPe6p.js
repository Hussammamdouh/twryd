import{u as N,r,a as _,j as t}from"./index-BBFhNgLA.js";import{u as L,S as O,T as $}from"./Topbar-ChzDmOJz.js";import{S as P}from"./StatusBadge-WEYTZPd0.js";import{d as T,p as w,g as D}from"./api-BUuAVsLY.js";import{C as M}from"./ConfirmModal-B6KWO9tH.js";import{S as v}from"./Spinner-DiswAH3X.js";import{P as R}from"./Pagination-C9j0xFOh.js";import{M as J}from"./Modal-BllzMBoT.js";import"./ThemeToggle-Conpg-30.js";const z=c=>{if(!c)return"N/A";try{return new Date(c).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"N/A"}};function F({invitations:c,loading:d,onAction:S,onInvite:l}){const{token:g}=N(),[o,x]=r.useState({}),[i,f]=r.useState({open:!1,type:"",inv:null}),u=_(),p=e=>{if(console.log("Invitation object:",e),e.client_email)return e.client_email;if(e.email)return e.email;if(e.contact)return e.contact;if(e.client?.email)return e.client.email;if(e.client?.contact)return e.client.contact;if(e.user?.email)return e.user.email;try{const s=JSON.parse(localStorage.getItem("supplier_invitations")||"{}")[e.id];if(s?.contact)return s.contact}catch(a){console.error("Error reading from localStorage:",a)}return"Email not available"},y=async(e,a)=>{x(s=>({...s,[a.id]:!0}));try{if(e==="cancel"){await T(`/api/supplier/invitations/${a.id}`,{token:g});try{const s=JSON.parse(localStorage.getItem("supplier_invitations")||"{}");delete s[a.id],localStorage.setItem("supplier_invitations",JSON.stringify(s))}catch(s){console.error("Error cleaning up localStorage:",s)}u.show("Invitation cancelled","success")}else e==="suspend"?(await w(`/api/supplier/invitations/clients/${a.client_id}/suspend`,{token:g}),u.show("Client suspended","success")):e==="reactivate"?(await w(`/api/supplier/invitations/clients/${a.client_id}/reactivate`,{token:g}),u.show("Client reactivated","success")):e==="resend"&&u.show("Resend not implemented in API","info");S?.()}catch(s){u.show(s.message||"Action failed","error")}finally{x(s=>({...s,[a.id]:!1})),f({open:!1,type:"",inv:null})}},m=(e,a)=>f({open:!0,type:e,inv:a}),j=()=>f({open:!1,type:"",inv:null}),b={cancel:"Are you sure you want to cancel this invitation?",suspend:"Are you sure you want to suspend this client?",reactivate:"Are you sure you want to reactivate this client?"};return d?t.jsx("div",{className:"flex justify-center py-12 text-theme-text-secondary",children:t.jsx(v,{size:24})}):!c||c.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-theme-text-muted gap-4",children:[t.jsx("div",{children:"No invitations found."}),t.jsx("button",{className:"theme-button px-4 py-2 rounded-lg font-bold shadow",onClick:l,children:"+ Invite New Client"})]}):t.jsxs("div",{className:"theme-table overflow-x-auto rounded-lg shadow",children:[t.jsxs("table",{className:"min-w-full text-sm md:table",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"theme-table-header text-theme-text",children:[t.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",children:"Email"}),t.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",children:"Status"}),t.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",children:"Sent Date"}),t.jsx("th",{className:"px-4 md:px-6 py-3 text-left font-semibold",children:"Actions"})]})}),t.jsx("tbody",{children:c.map(e=>t.jsxs("tr",{className:"border-b border-theme-border last:border-0 hover:bg-primary-50 dark:hover:bg-primary-900/10",children:[t.jsx("td",{className:"px-4 md:px-6 py-4 whitespace-nowrap text-theme-text",children:p(e)}),t.jsx("td",{className:"px-4 md:px-6 py-4",children:t.jsx(P,{status:e.status})}),t.jsx("td",{className:"px-4 md:px-6 py-4 text-theme-text",children:z(e.created_at||e.sent_at||e.sentDate)}),t.jsxs("td",{className:"px-4 md:px-6 py-4 flex flex-wrap gap-2",children:[e.status==="pending"&&t.jsxs("button",{className:"px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded shadow text-xs font-bold flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-red-400",onClick:()=>m("cancel",e),disabled:o[e.id],tabIndex:0,children:[o[e.id]&&t.jsx(v,{size:16,color:"border-white"}),"Cancel"]}),e.status==="accepted"&&t.jsxs("button",{className:`px-3 py-1 rounded shadow text-xs font-bold flex items-center gap-2 focus:outline-none focus:ring-2 ${e.relationship_status==="suspended"?"bg-green-100 text-green-700 hover:bg-green-200 focus:ring-green-400 dark:bg-green-900/30 dark:text-green-300":"bg-orange-100 text-orange-700 hover:bg-orange-200 focus:ring-orange-400 dark:bg-orange-900/30 dark:text-orange-300"}`,onClick:()=>m(e.relationship_status==="suspended"?"reactivate":"suspend",e),disabled:o[e.id]||!e.client_id,tabIndex:0,children:[o[e.id]&&t.jsx(v,{size:16,color:"border-current"}),e.relationship_status==="suspended"?"Reactivate":"Suspend"]}),e.status==="declined"&&t.jsx("button",{className:"px-3 py-1 bg-primary-100 text-primary-700 rounded shadow text-xs font-bold hover:bg-primary-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-primary-400 dark:bg-primary-900/30 dark:text-primary-300",onClick:()=>y("resend",e),disabled:o[e.id],tabIndex:0,children:"Resend"})]})]},e.id||e.email))})]}),t.jsx(M,{open:i.open,title:i.type.charAt(0).toUpperCase()+i.type.slice(1)+" Confirmation",message:b[i.type],onConfirm:()=>y(i.type,i.inv),onCancel:j,loading:o[i.inv?.id]})]})}const C=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,k=/^01[0-9]{9}$|^\+?[0-9]{10,15}$/;function G({open:c,onClose:d,onSuccess:S}){const[l,g]=r.useState(""),[o,x]=r.useState(!1),[i,f]=r.useState(""),[u,p]=r.useState(""),{token:y}=N(),m=_();function j(e){return e?!C.test(e)&&!k.test(e)?"Enter a valid email or phone number.":"":"Contact is required."}const b=async e=>{e.preventDefault();const a=j(l);if(f(a),!a){x(!0),p("");try{let s;if(C.test(l))s=await w("/api/supplier/invitations/invite-client",{data:{client_email:l,expiration_days:7},token:y});else if(k.test(l))s=await w("/api/supplier/invitations/generate",{data:{expiration_days:7},token:y});else throw new Error("Invalid contact format");if(s.data?.invitation?.id){const h=JSON.parse(localStorage.getItem("supplier_invitations")||"{}");h[s.data.invitation.id]={contact:l,created_at:new Date().toISOString(),invitation_url:s.data?.invitation_url||""},localStorage.setItem("supplier_invitations",JSON.stringify(h))}if(!s.data?.invitation?.token)throw new Error("No invitation token received from server");p(`Invitation link generated successfully! Share this link with ${l}:`),m.show("Invitation link generated successfully!","success"),g(""),setTimeout(()=>{p(""),d(),S?.()},1e4)}catch(s){f(s.message||"Failed to generate invitation"),m.show(s.message||"Failed to generate invitation","error")}finally{x(!1)}}};return t.jsx(J,{open:c,onClose:d,title:"Invite New Client",children:t.jsxs("form",{onSubmit:b,className:"space-y-4",children:[t.jsx("input",{type:"text",className:"w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-700",placeholder:"Enter client email or phone",value:l,onChange:e=>g(e.target.value),disabled:o}),i&&t.jsx("div",{className:"text-red-600 dark:text-red-400 text-sm",children:i}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{type:"button",className:"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg",onClick:d,disabled:o,children:"Cancel"}),t.jsx("button",{type:"submit",className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-60",disabled:o,children:o?"Sending...":"Generate Invitation Link"})]}),u&&t.jsx("div",{className:"text-green-600 dark:text-green-400 text-sm",children:u})]})})}function Z(){const[c,d]=r.useState(!1),[S,l]=r.useState([]),[g,o]=r.useState(!1),[x,i]=r.useState(1),[f,u]=r.useState(1),[p,y]=r.useState(""),[m,j]=r.useState(""),{token:b}=N(),{sidebarCollapsed:e}=L(),a=async()=>{o(!0);try{const n=await D(`/api/supplier/invitations?per_page=10&paginated=true&page=${x}`,{token:b}),h=n.data?.invitations?.data||n.data?.invitations||[];l(h),u(n.data?.invitations?.last_page||1)}catch(n){console.error("Failed to load invitations:",n.message)}finally{o(!1)}};r.useEffect(()=>{b&&a()},[b,x]);const s=r.useMemo(()=>S.filter(n=>{let h="";if(n.contact||n.email||n.client_email)h=n.contact||n.email||n.client_email;else try{h=JSON.parse(localStorage.getItem("supplier_invitations")||"{}")[n.id]?.contact||""}catch(I){console.error("Error reading from localStorage:",I)}const E=!p||h.toLowerCase().includes(p.toLowerCase()),A=!m||n.status===m;return E&&A}),[S,p,m]);return t.jsxs("div",{className:"min-h-screen bg-theme-bg",children:[t.jsx(O,{}),t.jsx($,{title:"Client Invitations",search:p,onSearch:y,status:m,onStatusChange:j,onInvite:()=>d(!0)}),t.jsx("main",{className:`pt-20 pr-8 transition-all duration-300 ${e?"pl-20":"pl-64"}`,children:t.jsxs("div",{className:"max-w-5xl mx-auto",children:[t.jsx(F,{invitations:s,loading:g,onAction:a,onInvite:()=>d(!0)}),t.jsx(R,{page:x,totalPages:f,onPageChange:i})]})}),t.jsx(G,{open:c,onClose:()=>d(!1),onSuccess:a})]})}export{Z as default};
